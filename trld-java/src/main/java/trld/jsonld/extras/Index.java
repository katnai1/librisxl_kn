/**
 * This file was automatically generated by the TRLD transpiler.
 * Source: trld/jsonld/extras/index.py
 */
package trld.jsonld.extras;

//import javax.annotation.Nullable;
import java.util.*;
import java.util.function.Function;
import java.util.regex.Pattern;
import java.util.stream.Stream;
import java.util.stream.Collectors;
import java.io.*;

import trld.Builtins;
import trld.KeyValue;

import static trld.jsonld.Base.ID;
import static trld.jsonld.Base.GRAPH;
import static trld.jsonld.Base.REVERSE;
import static trld.jsonld.Base.asList;

public class Index {

  public static Map<String, Map<String, Object>> makeIndex(List<Map<String, Object>> graph) {
    return makeIndex(graph, true);
  }
  public static Map<String, Map<String, Object>> makeIndex(List<Map<String, Object>> graph, Boolean addReverses) {
    Map<String, Map<String, Object>> index = new HashMap<>();
    for (Map<String, Object> item : graph) {
      /*@Nullable*/ String id = ((/*@Nullable*/ String) item.get(ID));
      if (id instanceof String) {
        index.put((String) id, item);
      }
    }
    if (addReverses) {
      indexReverses(index);
    }
    return index;
  }

  protected static void indexReverses(Map<String, Map<String, Object>> index) {
    for (Map<String, Object> item : index.values()) {
      if (!item.containsKey(ID)) {
        continue;
      }
      for (String link : item.keySet()) {
        List refs = (List) asList(item.get(link));
        for (Object ref : refs) {
          if (!(ref instanceof Map)) {
            continue;
          }
          Object linked = (Object) index.get(((String) ((Map) ref).get(ID)));
          if (!(linked instanceof Map)) {
            continue;
          }
          if (!((Map) linked).containsKey(REVERSE)) ((Map) linked).put(REVERSE, new HashMap<>());
          Map revmap = (Map) ((Map) linked).get(REVERSE);
          if (!revmap.containsKey(link)) revmap.put(link, new ArrayList<>());
          List<Map> revs = (List<Map>) revmap.get(link);
          if (!(revs.stream().anyMatch(rev -> (rev.get(ID) == null && ((Object) item.get(ID)) == null || rev.get(ID) != null && (rev.get(ID)).equals(item.get(ID)))))) {
            revs.add(Builtins.mapOf(ID, item.get(ID)));
          }
        }
      }
    }
  }
}
